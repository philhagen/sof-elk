# Logstash configuration for Volatility windows.cmdline output
# This parser handles JSON format from Volatility3 windows.cmdline plugin
# Extracts full command line arguments for each process
#
# Usage: Place JSON files in the input directory configured below
# Index Pattern: volatility-cmdline-*

filter {
  # Only process if this is a cmdline document
  if [type] == "volatility-cmdline" or "volatility-cmdline" in [tags] {

    # Parse JSON if it's a string
    if [message] {
      json {
        source => "message"
        target => "cmdline"
      }
    }

    # Extract command line information
    mutate {
      add_field => {
        "process_id" => "%{[cmdline][PID]}"
        "process_name" => "%{[cmdline][Process]}"
        "command_line" => "%{[cmdline][Args]}"
      }
      add_tag => [ "volatility", "memory_forensics", "execution_analysis", "cmdline" ]
    }

    # Convert numeric fields
    mutate {
      convert => {
        "process_id" => "integer"
      }
    }

    # Handle null command lines
    if [command_line] == "null" or [command_line] == "-" {
      mutate {
        remove_field => [ "command_line" ]
        add_field => { "has_cmdline" => "false" }
      }
    } else {
      mutate {
        add_field => { "has_cmdline" => "true" }
      }

      # Analyze command line for suspicious patterns
      # PowerShell encoded commands
      if [command_line] =~ /(?i)-enc|-encodedcommand|-e / {
        mutate {
          add_tag => [ "powershell_encoded", "suspicious_cmdline" ]
        }
      }

      # PowerShell download cradles
      if [command_line] =~ /(?i)iex|invoke-expression|downloadstring|webclient|downloadfile/ {
        mutate {
          add_tag => [ "powershell_download", "suspicious_cmdline" ]
        }
      }

      # PowerShell execution policy bypass
      if [command_line] =~ /(?i)-ep\s+bypass|-executionpolicy\s+bypass/ {
        mutate {
          add_tag => [ "powershell_bypass", "suspicious_cmdline" ]
        }
      }

      # Hidden/WindowStyle hidden
      if [command_line] =~ /(?i)-w\s+hidden|-windowstyle\s+hidden|-nop/ {
        mutate {
          add_tag => [ "powershell_hidden", "suspicious_cmdline" ]
        }
      }

      # Base64 patterns (long base64 strings)
      if [command_line] =~ /[A-Za-z0-9+\/=]{50,}/ {
        mutate {
          add_tag => [ "contains_base64", "suspicious_cmdline" ]
        }
      }

      # Common attack tools
      if [command_line] =~ /(?i)mimikatz|psexec|procdump|lsadump|sekurlsa|kerberos|dcsync/ {
        mutate {
          add_tag => [ "attack_tool", "suspicious_cmdline" ]
        }
      }

      # Living off the land binaries (LOLBins)
      if [command_line] =~ /(?i)certutil.*-decode|certutil.*-urlcache|bitsadmin.*\/transfer|mshta\s+http|regsvr32.*\/s.*\/u.*http|rundll32.*javascript|wmic.*process.*call.*create/ {
        mutate {
          add_tag => [ "lolbin", "suspicious_cmdline" ]
        }
      }

      # Suspicious scripting
      if [command_line] =~ /(?i)cscript|wscript.*\.vbs|wscript.*\.js/ {
        mutate {
          add_tag => [ "scripting_host" ]
        }
      }

      # Network operations
      if [command_line] =~ /(?i)net\s+(user|localgroup|group|share|use|view)|netsh|ipconfig|nslookup|ping/ {
        mutate {
          add_tag => [ "network_enumeration" ]
        }
      }

      # Lateral movement tools
      if [command_line] =~ /(?i)psexec|wmic.*\/node|winrs|powershell.*-computer/ {
        mutate {
          add_tag => [ "lateral_movement", "suspicious_cmdline" ]
        }
      }

      # WMI execution
      if [command_line] =~ /(?i)wmic.*process.*call.*create/ {
        mutate {
          add_tag => [ "wmi_execution", "suspicious_cmdline" ]
        }
      }

      # Task scheduler
      if [command_line] =~ /(?i)schtasks.*\/create|at\s+\d+:\d+/ {
        mutate {
          add_tag => [ "scheduled_task", "persistence_mechanism" ]
        }
      }

      # Registry operations
      if [command_line] =~ /(?i)reg\s+add|reg\s+save|reg\s+export/ {
        mutate {
          add_tag => [ "registry_modification" ]
        }
      }

      # File operations
      if [command_line] =~ /(?i)copy|move|xcopy|robocopy|del\s+\/f|erase\s+\/f/ {
        mutate {
          add_tag => [ "file_operation" ]
        }
      }

      # Credential dumping
      if [command_line] =~ /(?i)lsass|ntds\.dit|sam\s+save|system\s+save/ {
        mutate {
          add_tag => [ "credential_dumping", "suspicious_cmdline" ]
        }
      }
    }

    # Calculate command line length
    if [command_line] {
      ruby {
        code => "event.set('cmdline_length', event.get('command_line').length)"
      }

      # Flag unusually long command lines (often obfuscated)
      if [cmdline_length] {
        if [cmdline_length] > 1000 {
          mutate {
            add_tag => [ "long_cmdline", "suspicious_cmdline" ]
          }
        }
      }
    }

    # Classify process type based on name
    if [process_name] =~ /(?i)powershell|pwsh/ {
      mutate {
        add_field => { "process_type" => "powershell" }
      }
    } else if [process_name] =~ /(?i)cmd\.exe/ {
      mutate {
        add_field => { "process_type" => "cmd" }
      }
    } else if [process_name] =~ /(?i)wscript|cscript/ {
      mutate {
        add_field => { "process_type" => "script_host" }
      }
    } else if [process_name] =~ /(?i)wmic/ {
      mutate {
        add_field => { "process_type" => "wmi" }
      }
    }

    # Add metadata fields
    mutate {
      add_field => {
        "volatility_plugin" => "windows.cmdline"
        "analysis_type" => "command_line_analysis"
      }
    }

    # Clean up
    mutate {
      remove_field => [ "message" ]
    }
  }
}

output {
  if [type] == "volatility-cmdline" or "volatility-cmdline" in [tags] {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "volatility-cmdline-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
}
