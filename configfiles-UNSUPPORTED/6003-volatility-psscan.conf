# Logstash configuration for Volatility windows.psscan output
# This parser handles JSON format from Volatility3 windows.psscan plugin
# psscan scans physical memory for EPROCESS structures, finding hidden processes
#
# Usage: Place JSON files in the input directory configured below
# Index Pattern: volatility-psscan-*

filter {
  # Only process if this is a psscan document
  if [type] == "volatility-psscan" or "volatility-psscan" in [tags] {

    # Parse JSON if it's a string
    if [message] {
      json {
        source => "message"
        target => "process"
      }
    }

    # Extract process information
    mutate {
      add_field => {
        "process_id" => "%{[process][PID]}"
        "parent_process_id" => "%{[process][PPID]}"
        "process_name" => "%{[process][ImageFileName]}"
        "process_offset" => "%{[process][Offset(V)]}"
        "thread_count" => "%{[process][Threads]}"
        "handle_count" => "%{[process][Handles]}"
        "session_id" => "%{[process][SessionId]}"
        "is_wow64" => "%{[process][Wow64]}"
        "file_output" => "%{[process][File output]}"
      }
      add_tag => [ "volatility", "memory_forensics", "process_scan", "hidden_process_detection" ]
    }

    # Parse timestamps
    if [process][CreateTime] {
      date {
        match => [ "[process][CreateTime]", "ISO8601", "yyyy-MM-dd'T'HH:mm:ssZ", "yyyy-MM-dd'T'HH:mm:ss.SSSSSSZ" ]
        target => "process_create_time"
      }
    }

    if [process][ExitTime] and [process][ExitTime] != "N/A" {
      date {
        match => [ "[process][ExitTime]", "ISO8601", "yyyy-MM-dd'T'HH:mm:ssZ", "yyyy-MM-dd'T'HH:mm:ss.SSSSSSZ" ]
        target => "process_exit_time"
      }
      mutate {
        add_field => { "process_status" => "exited" }
      }
    } else {
      mutate {
        add_field => { "process_status" => "running" }
      }
    }

    # Convert numeric fields
    mutate {
      convert => {
        "process_id" => "integer"
        "parent_process_id" => "integer"
        "thread_count" => "integer"
        "is_wow64" => "boolean"
      }
    }

    # Handle null SessionId
    if [session_id] == "N/A" or [session_id] == "null" {
      mutate {
        remove_field => [ "session_id" ]
      }
    } else {
      mutate {
        convert => { "session_id" => "integer" }
      }
    }

    # Add metadata fields for tracking
    mutate {
      add_field => {
        "volatility_plugin" => "windows.psscan"
        "analysis_type" => "process_scan"
        "detection_method" => "physical_memory_scan"
      }
    }

    # Mark this for potential hidden process analysis
    # (comparing psscan results with pslist can reveal hidden processes)
    mutate {
      add_tag => [ "requires_correlation" ]
    }

    # Clean up
    mutate {
      remove_field => [ "message" ]
    }
  }
}

output {
  if [type] == "volatility-psscan" or "volatility-psscan" in [tags] {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "volatility-psscan-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
}
