# SOF-ELK Configuration File
# Volatility Memory Forensics - Master Tagger
#
# This preprocessing filter automatically detects Volatility data and
# extracts the module type from the file path, setting appropriate tags
# and type field for downstream processing.
#
# Path pattern: /logstash/volatility/<module>/filename.json
# Examples:
#   /logstash/volatility/pslist/case001.json    → type: volatility-pslist
#   /logstash/volatility/netscan/case001.json   → type: volatility-netscan
#
# This runs BEFORE the 6000-series filters to ensure proper routing.

filter {
  # Only process if this is Volatility data (check file path or existing type label)
  if [log][file][path] =~ /volatility/ or [type] == "volatility" or "volatility" in [tags] {

    # Extract the module name from the folder path automatically
    # This looks for the word after /volatility/ and sets it as the type
    if [log][file][path] {
      grok {
        match => { "[log][file][path]" => "/volatility/(?<v_module>[^/]+)/" }
        tag_on_failure => []
      }
    }

    # If we successfully extracted a module name, tag and set type
    if [v_module] {
      mutate {
        add_tag => [ "volatility", "memory_forensics", "volatility-%{v_module}" ]
        replace => { "type" => "volatility-%{v_module}" }
      }
    } else {
      # Fallback: just mark as generic volatility if we couldn't extract module
      mutate {
        add_tag => [ "volatility", "memory_forensics" ]
      }
    }

    # Add source identification
    mutate {
      add_field => { "[@metadata][data_source]" => "volatility" }
    }
  }
}
