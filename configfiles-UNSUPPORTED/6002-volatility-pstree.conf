# Logstash configuration for Volatility windows.pstree output
# This parser handles JSON format from Volatility3 windows.pstree plugin
# Note: This preserves the hierarchical structure with __children field
#
# Usage: Place JSON files in the input directory configured below
# Index Pattern: volatility-pstree-*

filter {
  # Only process if this is a pstree document
  if [type] == "volatility-pstree" or "volatility-pstree" in [tags] {

    # Parse JSON if it's a string
    if [message] {
      json {
        source => "message"
        target => "process"
      }
    }

    # Extract process information
    mutate {
      add_field => {
        "process_id" => "%{[process][PID]}"
        "parent_process_id" => "%{[process][PPID]}"
        "process_name" => "%{[process][ImageFileName]}"
        "process_offset" => "%{[process][Offset(V)]}"
        "thread_count" => "%{[process][Threads]}"
        "handle_count" => "%{[process][Handles]}"
        "session_id" => "%{[process][SessionId]}"
        "is_wow64" => "%{[process][Wow64]}"
      }
      add_tag => [ "volatility", "memory_forensics", "process_tree" ]
    }

    # Extract pstree-specific fields
    if [process][Audit] {
      mutate {
        add_field => { "process_path_audit" => "%{[process][Audit]}" }
      }
    }

    if [process][Cmd] {
      mutate {
        add_field => { "process_commandline" => "%{[process][Cmd]}" }
      }
    }

    if [process][Path] {
      mutate {
        add_field => { "process_path" => "%{[process][Path]}" }
      }
    }

    # Calculate process depth in tree (count asterisks in original tree representation)
    # This would need to be added by preprocessing
    if [process_depth] {
      mutate {
        convert => { "process_depth" => "integer" }
      }
    }

    # Parse timestamps
    if [process][CreateTime] {
      date {
        match => [ "[process][CreateTime]", "ISO8601", "yyyy-MM-dd'T'HH:mm:ssZ", "yyyy-MM-dd'T'HH:mm:ss.SSSSSSZ" ]
        target => "process_create_time"
      }
    }

    if [process][ExitTime] and [process][ExitTime] != "N/A" {
      date {
        match => [ "[process][ExitTime]", "ISO8601", "yyyy-MM-dd'T'HH:mm:ssZ", "yyyy-MM-dd'T'HH:mm:ss.SSSSSSZ" ]
        target => "process_exit_time"
      }
      mutate {
        add_field => { "process_status" => "exited" }
      }
    } else {
      mutate {
        add_field => { "process_status" => "running" }
      }
    }

    # Convert numeric fields
    mutate {
      convert => {
        "process_id" => "integer"
        "parent_process_id" => "integer"
        "thread_count" => "integer"
        "is_wow64" => "boolean"
      }
    }

    # Handle null SessionId
    if [session_id] == "N/A" or [session_id] == "null" {
      mutate {
        remove_field => [ "session_id" ]
      }
    } else {
      mutate {
        convert => { "session_id" => "integer" }
      }
    }

    # Store children count
    if [process][__children] {
      ruby {
        code => "event.set('children_count', event.get('[process][__children]').length)"
      }
    }

    # Add metadata fields
    mutate {
      add_field => {
        "volatility_plugin" => "windows.pstree"
        "analysis_type" => "process_tree"
      }
    }

    # Clean up
    mutate {
      remove_field => [ "message" ]
    }
  }
}

output {
  if [type] == "volatility-pstree" or "volatility-pstree" in [tags] {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "volatility-pstree-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
}
