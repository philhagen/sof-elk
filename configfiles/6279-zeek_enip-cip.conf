# SOF-ELKÂ® Configuration File
# (C)2025 Lewes Technology Consulting, LLC
#
# This file contains processing steps for Zeek's enip.log and cip.log, created by https://github.com/cisagov/ICSNPP
# See https://github.com/cisagov/icsnpp-enip

filter {
  if ([labels][type] == "zeek_enip" or [labels][type] == "zeek_cip") and "zeek_json" in [tags] {

    mutate {
      rename => {
        "[raw][uid]" => "[zeek][session_id]"
        "[raw][source_h]" => "[source][ip]"
        "[raw][source_p]" => "[source][port]"
        "[raw][destination_h]" => "[destination][ip]"
        "[raw][destination_p]" => "[destination][port]"
      }
    }

    if [labels][type] == "zeek_enip" {
      mutate {
        rename => {
          "[raw][packet_correlation_id]" => "[enip][packet_correlation_id]"
          "[raw][enip_command]" => "[enip][command_name]"
          "[raw][enip_command_code]" => "[enip][command_code]"
          "[raw][enip_status]" => "[enip][status_code]"
          "[raw][length]" => "[enip][length]"
          "[raw][options]" => "[enip][options]"
          "[raw][sender_context]" => "[enip][sender_context]"
          "[raw][session_handle]" => "[enip][session_handle]"
        }
      }

    } else if [labels][type] == "zeek_cip" {
      mutate {
        rename => {
          "[raw][packet_correlation_id]" => "[cip][packet_correlation_id]"
          "[raw][cip_service]" => "[cip][service_name]"
          "[raw][cip_service_code]" => "[cip][service_code]"
          "[raw][cip_sequence_count]" => "[cip][sequence_count]"
          "[raw][direction]" => "[cip][direction]"
        }
      }
    }

    # populate the @timestamp field with the ts value
    date {
      match => [ "[raw][ts]", "UNIX" ]
    }

    mutate {
      remove_field => "raw"
    }
  }
}
