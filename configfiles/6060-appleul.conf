# SOF-ELKÂ® Configuration File
# (C)2025 Lewes Technology Consulting, LLC
#
# This file contains filters, transforms, and enrichments for Apple Unified Log
# messages, using output from Mandiant/Google Cloud Security's
# macos-UnifiedLogs tool (https://github.com/mandiant/macos-UnifiedLogs)
# See also: https://cloud.google.com/blog/topics/threat-intelligence/reviewing-macos-unified-logs/

filter {
  if [labels][type] == "appleul" {
    mutate {
      lowercase => [
        "[raw][event_type]",
        "[raw][log_type]"
      ]
    }

    # "loss" happens when a log entry was lost and failed to record - discard
    # "signpost" events are for metric collection and monitoring
    if [raw][event_type] == "loss" {
      drop { }
    }

    mutate {
      rename => {
        "[raw][pid]" => "[process][pid]"
        "[raw][thread_id]" => "[process][thread][id]"
        "[raw][process_uuid]" => "[process][entity_id]"
        "[raw][process]" => "[process][executable]"
        "[raw][euid]" => "[process][user][id]"
        "[raw][timezone_name]" => "[event][timezone]"
        "[raw][subsystem]" => "[event][module]"
        "[raw][log_type]" => "[log][level]"
        "[raw][library]" => "[process][library][name]"
        "[raw][library_uuid]" => "[process][library][entity_id]"
        "[raw][boot_uuid]" => "[host][boot][id]"
        "[raw][message]" => "[message]"
      }

      add_field => { "[event][dataset]" => "appleul.%{[raw][event_type]}" }
    }

    # populate the @timestamp field
    date {
      match => [ "[raw][timestamp]", "ISO8601" ]
    }

    # documenting here for potential future reference:
    # - raw.message_entries.* contains a bunch of types, sizes, and strings that are populated into raw.raw_message.
    #   raw.raw_message is something like this: "Received XPC message ""%{public}s"" from session ""%{public}s"""
    #   This seems to be a "format string" of sorts that is populated with the appropriate values and dropped into
    #   the raw.message field. This is renamed to the "message" field above. Since this is done with rename => {},
    #   the destination is overwritten.
    # - from a ~79M record sample, only the following fields were observed that are NOT handled above:
    #   activity_id, category, and subsystem
    mutate {
      remove_field => "raw"
    }
  }
}
