# SOF-ELKÂ® Configuration File
# (C)2025 Lewes Technology Consulting, LLC
#
# This file contains processing steps for Zeek's omron_fins_detail.log, created by https://github.com/cisagov/ICSNPP
# See https://github.com/cisagov/icsnpp-omron-fins

filter {
  if [labels][type] == "zeek_omron_fins_detail" and "zeek_json" in [tags] {
    mutate {
      rename => {
        "[raw][uid]" => "[zeek][session_id]"
        "[raw][id.orig_h]" => "[source][ip]"
        "[raw][id.orig_p]" => "[source][port]"
        "[raw][id.resp_h]" => "[destination][ip]"
        "[raw][id.resp_p]" => "[destination][port]"
        "[raw][omron_fins_link_id]" => "[omron_fins][link_id]"
        "[raw][memory_area_code]" => "[omron_fins][memory_area_code]"
        "[raw][beginning_address]" => "[omron_fins][beginning_address]"
        "[raw][number_of_items]" => "[omron_fins][number_of_items]"
        "[raw][data]" => "[omron_fins][data]"
      }
    }

    # populate the @timestamp field with the ts value
    date {
      match => [ "[raw][ts]", "UNIX" ]
    }

    if [raw][command_code] {
      grok {
        match => { "[raw][command_code]" => [
          "%{GREEDYDATA:[omron_fins][command_name]} \(%{DATA:[omron_fins][command_code]}\)"
        ] }
      }
    }

    if [raw][icf_data_type] {
      grok {
        match => { "[raw][icf_data_type]" => [
          "%{GREEDYDATA:[omron_fins][data_type_name]} \(%{INT:[omron_fins][data_type_code]}\)"
        ] }
      }
    }
    
    if [raw][response_code] {
      grok {
        match => { "[raw][response_code]" => [
          "%{GREEDYDATA:[omron_fins][response_string]} \(%{DATA:[omron_fins][response_code]}\)"
        ] }
      }
    }

    mutate {
      remove_field => "raw"
    }
  }
}
