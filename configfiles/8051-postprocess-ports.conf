# SOF-ELKÂ® Configuration File
# (C)2023 Lewes Technology Consulting, LLC
#
# This file contains transforms and enrichments to be applied in postprocessing

filter {
  mutate {
    convert => {
      "source_port" => "integer"
      "destination_port" => "integer"
      "client_port" => "integer"
      "remote_port" => "integer"
      "backend_port" => "integer"
      "ftp_data_destination_port" => "integer"
    }
  }

### why not use merge?
# from ip processing:
# mutate { merge => { "ips" => "source_ip" } }
# would be like this here... cleaner:
# mutate { merge => { "ports" => "source_port" } }

  if [source_port] {
    mutate {
      add_field => {
        "ports" => [ "%{source_port}" ]
      }
    }
  }

  if [destination_port] {
    mutate {
      add_field => {
        "ports" => [ "%{destination_port}" ]
      }
    }
  }

  if [client_port] {
    mutate {
      add_field => {
        "ports" => [ "%{client_port}" ]
      }
    }
  }

  if [remote_port] {
    mutate {
      add_field => {
        "ports" => [ "%{remote_port}" ]
      }
    }
  }

  if [backend_port] {
    mutate {
      add_field => {
        "ports" => [ "%{backend_port}" ]
      }
    }
  }

  if [ftp_data_destination_port] {
    mutate {
      add_field => {
        "ports" => [ "%{ftp_data_destination_port}" ]
      }
    }
  }

  # de-duplicate the [ports] array
  ruby {
    code => '
      a = event.get("ports")
      if a.is_a? Array
        event.set("ports", a.uniq)
      end'
  }

}
