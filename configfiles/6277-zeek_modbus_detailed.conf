# SOF-ELKÂ® Configuration File
# (C)2025 Lewes Technology Consulting, LLC
#
# This file contains processing steps for Zeek's modbus_detailed.log, created by https://github.com/cisagov/ICSNPP
# See https://github.com/cisagov/icsnpp-modbus

filter {
  if [labels][type] == "zeek_modbus_detailed" and "zeek_json" in [tags] {
    mutate {
      rename => {
        "[raw][uid]" => "[zeek][session_id]"
        "[raw][id.orig_h]" => "[source][ip]"
        "[raw][id.orig_p]" => "[source][port]"
        "[raw][id.resp_h]" => "[destination][ip]"
        "[raw][id.resp_p]" => "[destination][port]"
        "[raw][func]" => "[modbus][function_code]"
        "[raw][matched]" => "[modbus][matched]"
#        "[raw][quantity]" => "[modbus][quantity]"
        "[raw][tid]" => "[modbus][transaction_id]"
        "[raw][unit]" => "[modbus][unit_id]"
        "[raw][request_values]" => "[modbus][request_values]"
        "[raw][response_values]" => "[modbus][response_values]"
        "[raw][response_data]" => "[modbus][response_data]"
        "[raw][address]" => "[modbus][address]"
      }
    }

    # TODO: what other fields are needed?  These have not been observed in samples so far, but may be useful
    #       exception_code
    #       mei_type
    #.      request_subfunction_code
    #.      response_subfunction_code

    # populate the @timestamp field with the ts value
    date {
      match => [ "[raw][ts]", "UNIX" ]
    }

    mutate {
      remove_field => "raw"
    }
  }
}
