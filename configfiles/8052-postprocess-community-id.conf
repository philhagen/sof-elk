# SOF-ELKÂ® Configuration File
# (C)2025 Lewes Technology Consulting, LLC
#
# This file adds a Community ID field for records with all of the necessary components
# Original script from RockNSM was used as a basis for this functionality

filter {
  # look up the text protocol for a numerical equivalent
  if [network][transport] and ![network][iana_number] {
    translate {
      dictionary_path => "/usr/local/sof-elk/lib/dictionaries/ip_proto_name2int.yaml"
      source => "[network][transport]"
      target => "[network][iana_number]"
    }

  # look up the numerical protocol number for a text equivalent
  } else if [network][iana_number] and ![network][transport] {
    translate {
      dictionary_path => "/usr/local/sof-elk/lib/dictionaries/ip_proto_int2name.yaml"
      source => "[network][iana_number]"
      target => "[network][transport]"
    }
  }

  if ([source][ip] and [destination][ip] and [network][iana_number] and [source][port] and [destination][port]) and ![network][community_id] {
    ruby {
      path => "/usr/local/sof-elk/supporting-scripts/community-id.rb"
      script_params => {
        "target_field" => "[network][community_id]"
      }
      tag_on_exception => "_rubyexception-community-id"
    }
  }
}
