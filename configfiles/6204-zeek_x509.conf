# SOF-ELKÂ® Configuration File
# (C)2023 Lewes Technology Consulting, LLC
#
# This file contains processing steps for Zeek's x509.log

# Reference: https://docs.zeek.org/en/master/scripts/base/files/x509/main.zeek.html#type-X509::Info

filter {
  if [type] == "zeek_x509" and "zeek_json" in [tags] {
    mutate {
      rename => {
        "[raw][fingerprint]" => "x509_fingerprint"
        "[raw][certificate.version]" => "certificate_version"
        "[raw][certificate.serial]" => "certificate_serial"
        "[raw][certificate.subject]" => "certificate_subject"
        "[raw][certificate.key_alg]" => "certificate_key_algorithm"
        "[raw][certificate.sig_alg]" => "certificate_signature_algorithm"
        "[raw][certificate.key_type]" => "certificate_key_type"
        "[raw][certificate.key_length]" => "certificate_key_length"
        "[raw][certificate.exponent]" => "certificate_exponent"
        "[raw][san.dns]" => "certificate_san"
        "[raw][basic_constraints.ca]" => "certificate_is_ca"
        "[raw][host_cert]" => "certificate_is_host_cert"
        "[raw][client_cert]" => "certificate_is_client_cert"
      }
    }

    # populate the @timestamp field with the ts value
    date {
      match => [ "[raw][ts]", "UNIX" ]
    }

    # handle cert validity dates
    date {
      match => [ "[raw][certificate.not_valid_before]", "UNIX" ]
      target => "certificate_not_valid_before"
    }
    date {
      match => [ "[raw][certificate.not_valid_after]", "UNIX" ]
      target => "certificate_not_valid_after"
    }

    mutate {
      remove_field => "raw"
    }
  }
}
